{% extends 'base.html' %}

{% block title %}{% if client %}Editar Cliente{% else %}Nuevo Cliente{% endif %} - Gym System{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{% url 'client_list' %}" class="text-decoration-none">
            <i class="fas fa-users me-1"></i>Clientes
        </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
        {% if client %}Editar{% else %}Nuevo{% endif %} Cliente
    </li>
{% endblock %}

{% block page_title %}
    <i class="fas {% if client %}fa-user-edit{% else %}fa-user-plus{% endif %} me-2"></i>
    {% if client %}Editar Cliente{% else %}Nuevo Cliente{% endif %}
{% endblock %}

{% block page_subtitle %}
    {% if client %}
        Actualiza la información de {{ client.first_name }} {{ client.last_name }}
    {% else %}
        Registra un nuevo cliente en el sistema
    {% endif %}
{% endblock %}

{% block header_actions %}
    <a href="{% url 'client_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Volver
    </a>
{% endblock %}

{% block content %}
<div class="row justify-content-center fade-in">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-id-card me-2"></i>
                    Información del Cliente
                </h5>
            </div>
            
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Nombre -->
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">
                                <i class="fas fa-user me-1"></i> Nombre *
                            </label>
                            <input type="text" 
                                   class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                                   id="first_name" 
                                   name="first_name" 
                                   value="{{ client.first_name|default:'' }}" 
                                   required
                                   maxlength="100">
                            <div class="invalid-feedback">
                                Por favor ingresa el nombre del cliente.
                            </div>
                            {% if form.first_name.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.first_name.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Nombre del cliente</div>
                        </div>
                        
                        <!-- Apellido -->
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">
                                <i class="fas fa-user me-1"></i> Apellido *
                            </label>
                            <input type="text" 
                                   class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                                   id="last_name" 
                                   name="last_name" 
                                   value="{{ client.last_name|default:'' }}" 
                                   required
                                   maxlength="100">
                            <div class="invalid-feedback">
                                Por favor ingresa el apellido del cliente.
                            </div>
                            {% if form.last_name.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.last_name.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Apellido del cliente</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Teléfono -->
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">
                                <i class="fas fa-phone me-1"></i> Teléfono *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">+52</span>
                                <input type="tel" 
                                       class="form-control {% if form.phone.errors %}is-invalid{% endif %}" 
                                       id="phone" 
                                       name="phone" 
                                       value="{{ client.phone|default:'' }}" 
                                       required
                                       pattern="[0-9]{10}"
                                       placeholder="10 dígitos sin espacios"
                                       maxlength="15">
                                <div class="invalid-feedback">
                                    Por favor ingresa un teléfono válido (10 dígitos).
                                </div>
                            </div>
                            {% if form.phone.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.phone.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Teléfono para notificaciones SMS</div>
                        </div>
                        
                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope me-1"></i> Email
                            </label>
                            <input type="email" 
                                   class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                   id="email" 
                                   name="email" 
                                   value="{{ client.email|default:'' }}"
                                   placeholder="cliente@ejemplo.com">
                            {% if form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.email.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Email para notificaciones (opcional)</div>
                        </div>
                    </div>
                    
                    <!-- Campos para edición -->
                    {% if client %}
                    <div class="row">
                        <!-- Estado Activo -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="active" 
                                       name="active" 
                                       {% if client.active %}checked{% endif %}>
                                <label class="form-check-label" for="active">
                                    <i class="fas fa-toggle-on me-1"></i> Cliente Activo
                                </label>
                            </div>
                            <div class="form-text">Desactiva si el cliente ya no asiste</div>
                        </div>
                        
                        <!-- Fecha de Registro -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i> Fecha de Registro
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   value="{{ client.created_at|date:'d/m/Y H:i' }}" 
                                   disabled>
                        </div>
                    </div>
                    
                    <!-- Información de Pagos -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i> Información de Pagos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Último Pago -->
                                <div class="col-md-6 mb-3">
                                    <label for="last_payment_date" class="form-label">
                                        Último Pago
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="last_payment_date" 
                                           name="last_payment_date"
                                           value="{{ client.last_payment_date|default:''|date:'Y-m-d' }}">
                                    <div class="form-text">Fecha del último pago recibido</div>
                                </div>
                                
                                <!-- Próximo Pago -->
                                <div class="col-md-6 mb-3">
                                    <label for="next_payment_date" class="form-label">
                                        Próximo Pago
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="next_payment_date" 
                                           name="next_payment_date"
                                           value="{{ client.next_payment_date|default:''|date:'Y-m-d' }}">
                                    <div class="form-text">Fecha del próximo pago esperado</div>
                                </div>
                            </div>
                            
                            <!-- Estado de Pago -->
                            <div class="mb-3">
                                <label for="payment_status" class="form-label">
                                    Estado de Pago
                                </label>
                                <select class="form-select" id="payment_status" name="payment_status">
                                    <option value="pending" {% if client.payment_status == 'pending' %}selected{% endif %}>
                                        Pendiente
                                    </option>
                                    <option value="paid" {% if client.payment_status == 'paid' %}selected{% endif %}>
                                        Pagado
                                    </option>
                                    <option value="overdue" {% if client.payment_status == 'overdue' %}selected{% endif %}>
                                        Vencido
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acción rápida -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="{% url 'renew_membership' client.id %}" 
                                   class="btn btn-outline-success">
                                    <i class="fas fa-sync-alt me-1"></i> Renovar Membresía
                                </a>
                                <a href="{% url 'send_client_sms' client.id %}" 
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-sms me-1"></i> Enviar SMS
                                </a>
                                <a href="{% url 'client_soft_delete' client.id %}" 
                                   class="btn btn-outline-danger">
                                    <i class="fas fa-trash me-1"></i> Eliminar
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Botones de formulario -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <div>
                            <a href="{% url 'client_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                        </div>
                        <div class="d-flex gap-2">
                            {% if client %}
                            <a href="{% url 'client_create' %}" class="btn btn-outline-primary">
                                <i class="fas fa-copy me-1"></i> Copiar como Nuevo
                            </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> 
                                {% if client %}Actualizar Cliente{% else %}Crear Cliente{% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Help Card -->
            <div class="card-footer bg-light">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Campos marcados con * son obligatorios
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">
                            <i class="fas fa-bell me-1"></i>
                            El cliente recibirá notificaciones por SMS
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats (solo para edición) -->
        {% if client %}
        <div class="row mt-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card small">
                    <i class="fas fa-calendar-check text-primary"></i>
                    <div class="stat-number">
                        {{ client.created_at|timesince }}
                    </div>
                    <div class="stat-label">Registrado hace</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card small">
                    <i class="fas fa-sms text-info"></i>
                    <div class="stat-number">
                        {{ client.smsnotification_set.count }}
                    </div>
                    <div class="stat-label">SMS Enviados</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card small">
                    {% if client.payment_status == 'paid' %}
                    <i class="fas fa-check-circle text-success"></i>
                    {% elif client.payment_status == 'pending' %}
                    <i class="fas fa-clock text-warning"></i>
                    {% else %}
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    {% endif %}
                    <div class="stat-number text-capitalize">
                        {{ client.get_payment_status_display }}
                    </div>
                    <div class="stat-label">Estado de Pago</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card small">
                    {% if client.active %}
                    <i class="fas fa-toggle-on text-success"></i>
                    {% else %}
                    <i class="fas fa-toggle-off text-danger"></i>
                    {% endif %}
                    <div class="stat-number">
                        {% if client.active %}Activo{% else %}Inactivo{% endif %}
                    </div>
                    <div class="stat-label">Estado</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validación de formulario
    document.addEventListener('DOMContentLoaded', function() {
        // Validación de teléfono
        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                // Solo permitir números
                this.value = this.value.replace(/\D/g, '');
                
                // Limitar a 10 dígitos
                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
            });
            
            phoneInput.addEventListener('blur', function() {
                if (this.value.length === 10) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                }
            });
        }
        
        // Validación de email
        const emailInput = document.getElementById('email');
        if (emailInput) {
            emailInput.addEventListener('blur', function() {
                if (this.value && !this.checkValidity()) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                    if (this.value) {
                        this.classList.add('is-valid');
                    }
                }
            });
        }
        
        // Auto-calcular próximo pago
        const lastPaymentInput = document.getElementById('last_payment_date');
        const nextPaymentInput = document.getElementById('next_payment_date');
        
        if (lastPaymentInput && nextPaymentInput) {
            lastPaymentInput.addEventListener('change', function() {
                if (this.value) {
                    const lastDate = new Date(this.value);
                    const nextDate = new Date(lastDate);
                    nextDate.setDate(nextDate.getDate() + 30); // +30 días
                    
                    // Formatear a YYYY-MM-DD
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    nextPaymentInput.value = nextDateStr;
                }
            });
        }
        
        // Auto-completar fecha de inicio para nuevo cliente
        {% if not client %}
        const today = new Date().toISOString().split('T')[0];
        const thirtyDaysLater = new Date();
        thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30);
        const futureDate = thirtyDaysLater.toISOString().split('T')[0];
        
        // Si existe el campo last_payment_date
        if (lastPaymentInput) {
            lastPaymentInput.value = today;
        }
        if (nextPaymentInput) {
            nextPaymentInput.value = futureDate;
        }
        {% endif %}
        
        // Prevenir envío si hay errores
        const form = document.querySelector('.needs-validation');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
</script>

<style>
    /* Estilos para stat-cards pequeñas */
    .stat-card.small {
        padding: 1rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-card.small i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-card.small .stat-number {
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .stat-card.small .stat-label {
        font-size: 0.75rem;
    }
    
    /* Estilos para inputs */
    .form-control.is-valid {
        border-color: #198754;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
</style>
{% endblock %}